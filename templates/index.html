<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>TradingGear — Python Only UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js" crossorigin="anonymous"></script>
<style>
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background:#0b1020; color:#e7eaf3; }
  .wrap { display:flex; flex-direction:column; height:100vh; }
  header { padding:12px 16px; display:flex; gap:12px; align-items:center; background:#101633; border-bottom:1px solid #1c254b; flex-wrap:wrap; }
  header input, header select, header button { background:#0f1533; color:#e7eaf3; border:1px solid #26305a; border-radius:10px; padding:8px 10px; }
  header button { cursor:pointer; }
  .hud { display:flex; gap:10px; flex-wrap:wrap; padding:8px 16px; background:#0e1430; border-bottom:1px dashed #26305a; }
  .hud .card { background:#0f1638; border:1px solid #26305a; border-radius:12px; padding:8px 12px; min-width:120px; }
  .chart-wrap { position:relative; flex:1; }
  #chart { position:absolute; inset:0; }
  #overlay { position:absolute; inset:0; pointer-events:none; z-index:9999; }
  .footer { padding:6px 16px; font-size:12px; color:#90a0c5; background:#0e1430; border-top:1px solid #1c254b; }
  .tag { padding:2px 6px; border-radius:8px; background:#1a234a; border:1px solid #2b3a78; font-size:12px; }
  .sep { flex:1; }
  .zoom-group { display:flex; gap:6px; align-items:center; }
  .zoom-btn { padding:6px 10px; border-radius:8px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <label>심볼 <input id="symbol" value="SOLUSDT" style="width:120px"/></label>
    <label>인터벌 
      <select id="interval">
        <option value="1m">1m</option><option value="3m">3m</option><option value="5m">5m</option>
        <option value="15m" selected>15m</option><option value="1h">1h</option><option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </label>
    <label><input type="checkbox" id="showVWAP" checked> VWAP</label>
    <label><input type="checkbox" id="showTEMA" checked> TEMA(30)</label>
    <label><input type="checkbox" id="showOB" checked> OB 존(테두리: 매수=초록, 매도=빨강)</label>
    <button id="loadBtn">불러오기</button>
    <button id="runStratBtn">전략계산</button>
    <span class="sep"></span>
    <div class="zoom-group">
      <span>Zoom</span>
      <button class="zoom-btn" id="zoomInBtn">+</button>
      <button class="zoom-btn" id="zoomOutBtn">−</button>
      <button class="zoom-btn" id="zoomResetBtn">Reset</button>
    </div>
    <span class="tag">Python Only UI</span>
  </header>

  <div class="hud" id="hud">
    <div class="card"><div>가격</div><div id="hud_price">-</div></div>
    <div class="card"><div>VWAP</div><div id="hud_vwap">-</div></div>
    <div class="card"><div>TEMA(30)</div><div id="hud_tema">-</div></div>
    <div class="card"><div>ATR(14)</div><div id="hud_atr">-</div></div>
    <div class="card"><div>ATR%</div><div id="hud_atrp">-</div></div>
    <div class="card"><div>CVD</div><div id="hud_cvd">-</div></div>
    <div class="card"><div>Trend</div><div id="hud_trend">-</div></div>
  </div>

  <div class="chart-wrap">
    <div id="chart"></div>
    <canvas id="overlay"></canvas>
  </div>

  <div class="footer">
    OB 박스: <span style="color:#34d399">초록=매수벽(수요존)</span>, <span style="color:#f87171">빨강=매도벽(공급존)</span>. 배경 없이 테두리만 표시됩니다.
  </div>
</div>

<script>
const api = (p) => p;
const $   = (id) => document.getElementById(id);

let chartApi, candleSeries, vwapSeries, temaSeries;
let zones = [];
let lastKs = [];

function fmt(n, d=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(d); }

function buildChart(){
  const chartContainer = $("chart");
  const overlay        = $("overlay");

  chartApi = LightweightCharts.createChart(chartContainer, {
    width: chartContainer.clientWidth, height: chartContainer.clientHeight,
    layout: { background: { type: 'solid', color: '#0b1020' }, textColor: '#e7eaf3' },
    grid: { vertLines: { color: '#1a234a' }, horzLines: { color: '#1a234a' } },
    timeScale: { borderColor: '#2b3a78' }, rightPriceScale: { borderColor: '#2b3a78' },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  candleSeries = chartApi.addCandlestickSeries({
    upColor:'#2dd4bf', downColor:'#f87171',
    borderUpColor:'#2dd4bf', borderDownColor:'#f87171',
    wickUpColor:'#2dd4bf', wickDownColor:'#f87171'
  });
  vwapSeries = chartApi.addLineSeries({ color:'#8ab4ff', lineWidth:1, visible: $('showVWAP').checked });
  temaSeries = chartApi.addLineSeries({ color:'#ffd166', lineWidth:1, visible: $('showTEMA').checked });

  function resize(){
    const rect = chartContainer.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    overlay.width  = Math.max(1, Math.floor(rect.width * dpr));
    overlay.height = Math.max(1, Math.floor(rect.height * dpr));
    overlay.style.width = rect.width + 'px'; overlay.style.height = rect.height + 'px';
    drawZones();
  }
  const ro = new ResizeObserver(resize); ro.observe(chartContainer);
  chartApi.timeScale().subscribeVisibleTimeRangeChange(drawZones);
  chartApi.subscribeCrosshairMove(drawZones);
  resize();
}

function timeToX(t){ const x = chartApi.timeScale().timeToCoordinate(t); return (x == null) ? null : x * devicePixelRatio; }
function priceToY(p){ const y = candleSeries.priceToCoordinate(p); return (y == null) ? null : y * devicePixelRatio; }

function localDetectOb(ks, extend = 150) {
  const out = []; const start = Math.max(1, ks.length - 800);
  for (let i = start; i < ks.length - 1; i++) {
    const b = ks[i]; const fut = ks.slice(i + 1, Math.min(i + 1 + extend, ks.length)); if (!fut.length) continue;
    const top = Math.max(b.o, b.c, b.h), bottom = Math.min(b.o, b.c, b.l);
    if (b.c < b.o && fut.some(x => x.h >= b.h)) { out.push({ type:"bullish", start:b.t, end:ks.at(-1).t, top:top, bottom:bottom }); }
    if (b.c > b.o && fut.some(x => x.l <= b.l)) { out.push({ type:"bearish", start:b.t, end:ks.at(-1).t, top:top, bottom:bottom }); }
  }
  return out.slice(-20);
}

function drawZones(){
  const canvas = $('overlay'); const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!$('showOB').checked) return;

  zones.forEach(z=>{
    let x1 = timeToX(z.start), x2 = timeToX(z.end), y1 = priceToY(z.top), y2 = priceToY(z.bottom);
    if (x1 == null) x1 = 0; if (x2 == null) x2 = canvas.width; if (y1 == null) y1 = 0; if (y2 == null) y2 = canvas.height;
    const left = Math.min(x1,x2), right = Math.max(x1,x2), top = Math.min(y1,y2), bottom = Math.max(y1,y2);
    const w = Math.max(1, right-left), h = Math.max(1, bottom-top);

    const dpr = window.devicePixelRatio || 1;

    ctx.save();
    ctx.beginPath();
    ctx.rect(left, top, w, h);
    const green = 'rgba(52, 211, 153, 0.95)';   // #34d399 (매수)
    const red   = 'rgba(248, 113, 113, 0.95)';  // #f87171 (매도)
    ctx.strokeStyle = (z.type === 'bullish') ? green : red;
    ctx.lineWidth = 2 * dpr;
    ctx.setLineDash([6 * dpr, 4 * dpr]); // 점선(원하면 제거)
    ctx.stroke();
    ctx.restore();
  });
}

async function refreshZones({ forceServer=false } = {}){
  const symbol = $('symbol').value.trim().toUpperCase();
  const interval = $('interval').value;

  if (!$('showOB').checked) { zones = []; drawZones(); return; }

  let srvZones = [];
  if (forceServer) {
    try {
      const z = await fetch(api(`/api/zones/ob?symbol=${symbol}&interval=${interval}&lookback=500&extend=150&debug=true`)).then(r=>r.json());
      console.log('OB server debug:', z.debug || {});
      srvZones = Array.isArray(z.zones) ? z.zones : [];
    } catch(e) { console.warn('server zones error', e); }
  }
  zones = srvZones;

  if (!zones || zones.length === 0) {
    if (!lastKs.length) {
      try { lastKs = await fetch(api(`/api/klines?symbol=${symbol}&interval=${interval}&limit=500`)).then(r=>r.json()); }
      catch(e){ console.warn('klines fetch fail for local OB', e); }
    }
    if (lastKs.length) {
      zones = localDetectOb(lastKs, 150);
      console.warn('fallback local OB zones:', zones.length);
    }
  }
  if (!zones || zones.length === 0) {
    const last = lastKs.at(-1);
    if (last) {
      zones = [{ type:'bullish', start:last.t-3600, end:last.t, top:last.c*1.003, bottom:last.c*0.997 }];
      console.warn('Painted a debug OB box since none detected.');
    }
  }
  drawZones();
}

function zoomBy(factor){
  const ts = chartApi.timeScale();
  const lr = ts.getVisibleLogicalRange();
  const totalBars = Math.max(1, lastKs.length);
  if (!lr) { ts.fitContent(); requestAnimationFrame(drawZones); return; }

  let from = lr.from, to = lr.to;
  let width = Math.max(1, to - from);
  const minBars = 10;
  const maxBars = Math.max(20, totalBars);
  let newWidth = Math.max(minBars, Math.min(width * factor, maxBars));
  const center = (from + to) / 2;
  let newFrom = center - newWidth / 2;
  let newTo   = center + newWidth / 2;

  if (newFrom < 0) { newTo -= newFrom; newFrom = 0; }
  if (newTo > totalBars - 1) { newFrom -= (newTo - (totalBars - 1)); newTo = totalBars - 1; }

  ts.setVisibleLogicalRange({ from: newFrom, to: newTo });
  requestAnimationFrame(drawZones);
}

function zoomReset(){
  chartApi.timeScale().fitContent();
  requestAnimationFrame(drawZones);
}

async function loadAll(){
  const symbol = $('symbol').value.trim().toUpperCase();
  const interval = $('interval').value;

  lastKs = await fetch(api(`/api/klines?symbol=${symbol}&interval=${interval}&limit=500`)).then(r=>r.json());
  const candles = lastKs.map(k=>({ time:k.t, open:k.o, high:k.h, low:k.l, close:k.c }));
  candleSeries.setData(candles);
  chartApi.timeScale().fitContent();

  const vwapArr = (()=>{ let cpv=0, cv=0; return lastKs.map(k=>{ const tp=(k.h+k.l+k.c)/3; cpv+=tp*k.v; cv+=k.v; return cv>0?cpv/cv:tp; }); })();
  const temaArr = (function temaCalc(L){ 
    const ema=(s,l)=>{ const k=2/(l+1); let p=null; return s.map(x=>{ p=(p===null?x:(x*k+p*(1-k))); return p; }); };
    const closes = lastKs.map(k=>k.c); const e1=ema(closes, L), e2=ema(e1,L), e3=ema(e2,L);
    return e1.map((_,i)=>3*e1[i]-3*e2[i]+e3[i]);
  })(30);

  vwapSeries.setData(lastKs.map((k,i)=>({ time:k.t, value:vwapArr[i] })));
  temaSeries.setData(lastKs.map((k,i)=>({ time:k.t, value:temaArr[i] })));
  vwapSeries.applyOptions({ visible: $('showVWAP').checked });
  temaSeries.applyOptions({ visible: $('showTEMA').checked });

  await refreshZones({ forceServer:true });

  const sigs = await fetch(api(`/api/signals?symbol=${symbol}&interval=${interval}&limit=200`)).then(r=>r.json()).catch(()=>[]);
  const markers = (sigs || []).map(s=>({ time: s.ts, position: s.side==='LONG' ? 'belowBar' : 'aboveBar', color: s.side==='LONG' ? '#2dd4bf' : '#f87171', shape: s.side==='LONG' ? 'arrowUp' : 'arrowDown', text: s.side }));
  candleSeries.setMarkers(markers);

  requestAnimationFrame(drawZones);
  await refreshHUD();
}

async function refreshHUD(){
  const symbol = $('symbol').value.trim().toUpperCase();
  const interval = $('interval').value;
  const h = await fetch(api(`/api/hud?symbol=${symbol}&interval=${interval}&limit=500`)).then(r=>r.json()).catch(()=>null);
  if(!h) return;
  $("hud_price").textContent = fmt(h.last_price);
  $("hud_vwap").textContent  = fmt(h.vwap);
  $("hud_tema").textContent  = fmt(h.tema30);
  $("hud_atr").textContent   = fmt(h.atr14);
  $("hud_atrp").textContent  = h.atrp ? fmt(h.atrp*100,2)+'%' : '-';
  $("hud_cvd").textContent   = fmt(h.cvd,0);
  $("hud_trend").textContent = h.trend==='up' ? '상승' : '하락';
}

async function runStrategy(){
  const symbol = $('symbol').value.trim().toUpperCase();
  const interval = $('interval').value;
  await fetch(api(`/api/strategy/run?symbol=${symbol}&interval=${interval}&limit=500&tema_len=30&atr_len=14&vwap_filter=true&atr_distance_mult=0.0&cooldown_bars=5`), { method:'POST' });
  const sigs = await fetch(api(`/api/signals?symbol=${symbol}&interval=${interval}&limit=200`)).then(r=>r.json()).catch(()=>[]);
  const markers = (sigs || []).map(s=>({ time: s.ts, position: s.side==='LONG' ? 'belowBar' : 'aboveBar', color: s.side==='LONG' ? '#2dd4bf' : '#f87171', shape: s.side==='LONG' ? 'arrowUp' : 'arrowDown', text: s.side }));
  candleSeries.setMarkers(markers);
}

window.addEventListener('DOMContentLoaded', ()=>{
  buildChart();
  $('loadBtn').addEventListener('click', loadAll);
  $('runStratBtn').addEventListener('click', runStrategy);
  $('showVWAP').addEventListener('change', e=> vwapSeries.applyOptions({ visible: e.target.checked }));
  $('showTEMA').addEventListener('change', e=> temaSeries.applyOptions({ visible: e.target.checked }));
  $('showOB').addEventListener('change', async (e)=>{
    if (e.target.checked) { await refreshZones({ forceServer:true }); }
    else { zones = []; drawZones(); }
  });

  $('zoomInBtn').addEventListener('click', ()=> zoomBy(0.7));
  $('zoomOutBtn').addEventListener('click', ()=> zoomBy(1.3));
  $('zoomResetBtn').addEventListener('click', zoomReset);

  loadAll();
  setInterval(refreshHUD, 5000);
});
</script>
</body>
</html>
